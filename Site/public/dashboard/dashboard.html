<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-20">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
  <script src="https://kit.fontawesome.com/6921956092.js" crossorigin="anonymous"></script>
  <script src="C:\Users\isafa\Documents\SPTECH\PROJETO AGORA VAI\ProjetoInFlow\Site\public\js\sessao.js"></script>
</head>

<body onload="validarSessao(), exibirCorredores(),  atualizacaoPeriodica(), atualizarKPIs();"></body>
<div class="container">
  <!-- MENU LATERAL -->
  <div id="menu">
    <div class="logo">
      <h1>In<span>Flow</span></h1>
    </div>
    <div class="escolha">
      <div class="box agora">
        <div class="icon">
          <i class="fa-solid fa-table-columns"></i>
        </div>
        <a href="dashboard.html" class="titulo">Dashboard Analítica</a>
      </div>
      <div class="box">
        <div class="icon">
          <i class="fa-solid fa-gauge"></i>
        </div>
        <a href="mapaDeCalor.html" class="titulo">Dashboard de Gestão</a>
      </div>
      <div class="box">
        <div class="icon">
          <i class="fa-solid fa-users"></i>
        </div>
        <a href="cadastro.html" class="titulo">Adicionar usuários</a>
      </div>
      <div class="box">
        <div class="icon">
          <i class="fa-solid fa-gear"></i>
        </div>
        <p class="titulo">Configurações</p>
      </div>
      <div class="box" onclick="sair()">
        <div class="icon">
          <i class="fa-solid fa-right-from-bracket"></i>
        </div>
        <p class="titulo">Sair</p>
      </div>
    </div>
    <div class="dadosPerfil">
      <div class="fotoPerfil conteudo">
        <img src="../assets/img/homem1.jpg" alt="">
      </div>
      <div class="infoPerfil conteudo">
        <p class="nome">Renato</p>
        <p class="email">renato.silva@gmail.com</p>
      </div>
      <div class="maisInfo conteudo">
        <i class="fa-solid fa-angle-right"></i>
      </div>
    </div>
  </div>
  <!-- FIM DO MENU LATERAL -->
  <div id="main">
    <div class="conteudoDashboard">
      <div class="div_titulo_mercado">
        <h1 class="nome-mercado"> Carrefour 12312</h1>
      </div>

        <div class="container-mes-card">
          <div class="card-fluxo">
            <div class="fluxo-paragrafo">
              <p class="texto-card">Fluxo:</p>
              <p class="paragrafo-texto">É a quantidade de ativações de pessoas passando pelo sensor em um certo momento
              </p>
            </div>
          </div>

          <div class="select card-mes">
            <div>
              <label for="select_mes">Escolha o mês:</label>
              <br>
              <select id="select_mes">
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Março</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
              </select>
            </div>
            <div>
              <label for="select_ano">Escolha o ano:</label>
              <br>
              <select id="ano_g3">
                <option value="2025">2025</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
              </select>
            </div>

          <button class="botao-escolher-mes"
            onclick=" obterDadosGraficoMedidas(sessionStorage.SUPERMERCADO),obterDadosPizza(sessionStorage.SUPERMERCADO), atualizarKPIs();">
            Buscar</button>
        </div>
      </div>
        <script>
          /*
           var select_mes = document.getElementById("select_mes");
           var select_ano = document.getElementById("select_ano");
 
           select_mes.value = new Date().getMonth() + 1; // Mês atual (1-12)
           select_ano.value = new Date().getFullYear(); // Ano atual
         */
        </script>

      <div id="div_mes_escolhido"> </div>
      <div class="elementosKPI">
        <div class="kpi k1">
          <p class="titulo">Ativações totais</p>
          <div class="dados">
            <p>40000</p>

            <!--<p>10% Maior que o mes passado</p>-->
          </div>
        </div>
        <div class="kpi k2">
          <p class="titulo">Corredor com maior fluxo</p>
          <div class="dados">
            <p>6</p>
            <!--<p>Com picos a sexta no periodo da tarde</p>-->
          </div>
        </div>
        <div class="kpi k3">
          <p class="titulo"> Dia com maior fluxo</p>
          <div class="dados">
            <p>10</p>

          </div>
        </div>
        <div class="kpi k4">
          <p class="titulo">Corredor com menor fluxo</p>
          <div class="dados">
            <p>Corredor 4</p>

          </div>
        </div>
      </div>
      <!-- <div class="calendar">
          <div class="header">
            <button id="prev">&#9664;</button>
            <h2 id="monthYear"></h2>
            <button id="next">&#9654;</button>
          </div>
          <div class="weekdays">
            <div>Sun</div>
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
          </div>
          <div class="days" id="calendarDays"></div>
          <div class="selection-info">
            <p>Selected: <span id="selectionDisplay">None</span></p>
          </div>
        </div> -->

      <div class="conteudoGrafico">


        <div class="grafico">
          <canvas id="graficoPizza"></canvas>
        </div>
        <div class="graficoBarra ">
          <canvas id="graficoBarra"></canvas>
        </div>
      </div>
      <div class="corredores" id="corredores">
        <div id="btnCorredor" class="btns-dash">
        </div>
      </div>
      <div class="graficocorredores">
        <div class="selectano">

        </div>
        <div id="container-corredor" class="container-corredor">
          <div class="container-cards-grafico">
          <div class="select-ano">
            <select id="ano_g3">
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
            </select>
          </div>
          <div id="graficos" class="graficos"></div>
        </div>
      </div>



        <div class="heatmaparea">
          <h1>Mapa de calor</h1>
          <p>Acompanhe em tempo real a movimentação</p>
          <div class="heatmap">
            <div id="heatmapContainer"></div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
</div>
</div>
</body>



</html>
<script>
  window.onload = exibirCorredorDoUsuario()
  window.onload = obterDadosGraficoMedidas(sessionStorage.SUPERMERCADO)
  window.onload = obterDadosPizza(sessionStorage.SUPERMERCADO)
  window.onload = atualizarKPIs();

  function atualizarKPIs() {
    const idSupermercado = sessionStorage.SUPERMERCADO;
    const mes = document.getElementById('select_mes').value;
    const ano = document.getElementById('select_ano').value;
    console.log(`datas:${idSupermercado}, ${mes}, ${ano}`);
    fetch(`/kpi/kpis/${idSupermercado}?mes=${mes}&ano=${ano}`)
      .then(response => response.json())
      .then(data => {
        document.querySelector('.kpi.k1 .dados p:first-child').textContent = data.totalAtivacoes;
        document.querySelector('.kpi.k2 .dados p:first-child').textContent = data.corredorMaiorFluxo;
        document.querySelector('.kpi.k3 .dados p:first-child').textContent = data.diaMaiorFluxo;
        document.querySelector('.kpi.k4 .dados p:first-child').textContent = data.corredorMenorFluxo;
      })
      .catch(err => console.error('Erro ao buscar KPIs:', err));
  }
  function exibirCorredorDoUsuario() {
    var corredores = JSON.parse(sessionStorage.CORREDORES)
    console.log(corredores.id)
    var anocorredor = document.getElementById("ano_g3").value
    corredores.forEach(item => {
      document.getElementById("btnCorredor").innerHTML += `
            <button class="btn-chart" onclick="exibirCorredor(${item.id})" id="btnCorredor${item.id}">${item.posicao}</button>
            `

      document.getElementById("graficos").innerHTML += `
                <div id="grafico${item.id}" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloCorredor${item.id}">${item.posicao}</span>
                    </h3>
                    <div class="graph">
                        <canvas id="myChartCanvas${item.id}"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura${item.id}" style="color: white"></p>
                    </div>
                </div>
            `

      obterDadosGraficoCorredores(item.id, item.fksupermercado, anocorredor)
    });

    if (corredores.length > 0) {
      exibirCorredor(corredores[0].id)
    }
  }

  function alterarTitulo(idCorredor) {
    var tituloCorredor = document.getElementById(`tituloCorredor${idCorredor}`)
    var descricao = JSON.parse(sessionStorage.CORREDORES).find(item => item.id == idCorredor).posicao;
    tituloCorredor.innerHTML = " Fluxo por mês no <span style='color: #008080'>" + descricao + "</span>"
  }

  function exibirCorredor(idCorredor) {
    let todosOsGraficos = JSON.parse(sessionStorage.CORREDORES);

    for (let i = 0; i < todosOsGraficos.length; i++) {
      // exibindo - ou não - o gráfico
      if (todosOsGraficos[i].id != idCorredor) {
        let elementoAtual = document.getElementById(`grafico${todosOsGraficos[i].id}`)
        if (elementoAtual.classList.contains("display-block")) {
          elementoAtual.classList.remove("display-block")
        }
        elementoAtual.classList.add("display-none")

        // alterando estilo do botão
        let btnAtual = document.getElementById(`btnCorredor${todosOsGraficos[i].id}`)
        if (btnAtual.classList.contains("btn-pink")) {
          btnAtual.classList.remove("btn-pink")
        }
        btnAtual.classList.add("btn-white")
      }
    }

    // exibindo - ou não - o gráfico
    let graficoExibir = document.getElementById(`grafico${idCorredor}`)
    graficoExibir.classList.remove("display-none")
    graficoExibir.classList.add("display-block")

    // alterando estilo do botão
    let btnExibir = document.getElementById(`btnCorredor${idCorredor}`)
    btnExibir.classList.remove("btn-white")
    btnExibir.classList.add("btn-pink")
  }

  // O gráfico é construído com três funções:
  // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
  // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
  // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

  // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
  // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
  // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function obterDadosGraficoCorredores(idCorredor, idSupermercado, ano) {

    alterarTitulo(idCorredor);

    fetch(`/dashboard/dadosCorredor/${idSupermercado}/${idCorredor}/${ano}`).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta, idCorredor);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, idCorredor) {

    console.log('iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels
    let labels = [];

    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [{
        label: 'Fluxo',
        data: [],
        fill: false,
        backgroundColor: '#008080',
        borderColor: '#008080',
        tension: 0.1
      }]
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    let nomeMeses = [
      'Janeiro',
      'Fevereiro',
      'Março',
      'Abril',
      'Maio',
      'Junho',
      'Julho',
      'Agosto',
      'Setembro',
      'Outubro',
      'Novembro',
      'Dezembro'
    ]

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      var mes = registro.mes;

      labels.push(nomeMeses[mes - 1])
      dados.datasets[0].data.push(registro.total_movimentacoes);

    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'bar',
      data: dados,
    };

    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
      document.getElementById(`myChartCanvas${idCorredor}`),
      config
    );

  }

  /////////////////////////////////////////////////////////////////

  let myChartBarra = null
  function obterDadosGraficoMedidas(idSupermercado) {
    let mes = Number(select_mes.value)
    let ano = Number(select_ano.value)
    console.log(sessionStorage.SUPERMERCADO)


    fetch(`/medidas/fluxo/${idSupermercado}/${mes}/${ano}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGraficoBarras(resposta, idSupermercado);

        })
      } else {
        console.error('Nenhum dado encontrado ou erro na API')
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  function obterDadosPizza(idSupermercado) {
    let mes = Number(select_mes.value);
    let ano = Number(select_ano.value);
    console.log(sessionStorage.SUPERMERCADO)
    fetch(`/medidas/pizza/${idSupermercado}/${mes}/${ano}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGraficoPizza(resposta, idSupermercado);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }




  function plotarGraficoBarras(resposta, idSupermercado) {
    console.log('Iniciando plotagem do gráfico de barras...');
    if (myChartBarra) {
      myChartBarra.destroy();
    }

    let labels = [];


    let dadosFluxo = [];


    for (let i = 0; i < resposta.length; i++) {
      let registro = resposta[i];
      labels.push(`Corredor ${registro.corredor}`);
      dadosFluxo.push(registro.fluxoPessoas);
    }

    // Estrutura de dados para o gráfico
    let dados = {
      labels: labels,
      datasets: [{
        label: 'Fluxo de Pessoas',
        data: dadosFluxo,
        backgroundColor: '#008080',
        borderColor: '#008080',
        borderWidth: 1
      }]
    };

    // Configuração do gráfico de barras
    const config = {
      type: 'bar',
      data: dados,
      options: {
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Fluxo de Pessoas',

            }
          },
          x: {
            title: {
              display: true,
              text: 'Corredores'
            }
          }
        },
        plugins: {
          legend: {
            display: true
          },
          title: {
            display: true,
            text: 'Fluxo de Pessoas por Corredor'
          }
        }
      }
    };

    myChartBarra = new Chart(
      document.getElementById(`graficoBarra`),
      config
    );
  }
  let myChartPizza = null
  function plotarGraficoPizza(resposta, idSupermercado) {
    console.log('Iniciando plotagem do gráfico de pizza...');
    console.log(resposta);
    if (myChartPizza) {
      myChartPizza.destroy();
    }
    let dados = []

    for (let i = 0; i < resposta.length; i++) {
      let registro = resposta[i];
      dados.push(registro.Total_Registros);

    }

    const div_pizza = document.getElementById('graficoPizza').getContext('2d');
    console.log(dados);
    myChartPizza = new Chart(div_pizza, {
      type: 'pie',
      data: {
        labels: ['Manhã', 'Noite', 'Tarde'],
        datasets: [{
          label: 'Movimentação por período',
          data: dados,
          backgroundColor: ['#0f766e', '#14b8a6', '#5eead4'],
          borderColor: '#fff',
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: 'Distribuição de Movimento por Período do Dia',
            font: {
              size: 18
            }
          },
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }



  const heatmapInstance = h337.create({
    container: document.getElementById('heatmapContainer'),
    radius: 70,
  });

  const data = {
    max: 100,
    data: [
      { x: 500, y: 100, value: 100 },
      { x: 400, y: 300, value: 60 },
      { x: 100, y: 400, value: 90 },
      { x: 200, y: 200, value: 40 },
      { x: 100, y: 100, value: 70 },
      { x: 250, y: 450, value: 80 },
      { x: 500, y: 400, value: 95 },
      { x: 50, y: 300, value: 40 },
    ]
  };

  heatmapInstance.setData(data);



  function exibirCorredores() {
    JSON.parse(sessionStorage.CORREDORES).forEach(item => {
      document.getElementById("corredores").innerHTML += `
                    <div class="corredor">
            
                            <h1>${item.id}</h1>
                            <p>AREA:${item.nome}</p>

                      
                    </div>
                    `
    });
  }


  function sair() {
    sessionStorage.clear()
    window.location.href = "../login.html";
  }
</script>