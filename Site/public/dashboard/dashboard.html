<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-20">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.0/heatmap.min.js"></script>
  <script src="https://kit.fontawesome.com/6921956092.js" crossorigin="anonymous"></script>
  <script src="js/sessao"></script>
  <script src="js/sessao"></script>
</head>

<body onload="validarSessao(), exibirCorredores(),  atualizacaoPeriodica()"></body>
<div class="container">
  <!-- MENU LATERAL -->
  <div id="menu">
    <div class="logo">
      <h1>In<span>Flow</span></h1>
    </div>
    <div class="escolha">
      <div class="box">
        <div class="icon">
          <i class="fa-solid fa-table-columns"></i>
        </div>
        <a href="dashboard.html" class="titulo">Dashboard Analítica</a>
      </div>
      <div class="box agora">
        <div class="icon">
          <i class="fa-solid fa-gauge"></i>
        </div>
        <a href="mapaDeCalor.html" class="titulo">Dashboard de Gestão</a>
      </div>
      <div class="box">
        <div class="icon">
          <i class="fa-solid fa-users"></i>
        </div>
        <a href="cadastro.html" class="titulo">Adicionar usuários</a>
      </div>
      <div class="box">
        <div class="icon">
          <i class="fa-solid fa-gear"></i>
        </div>
        <p class="titulo">Configurações</p>
      </div>
    </div>
    <div class="dadosPerfil">
      <div class="fotoPerfil conteudo">
        <img src="assets/img/homem1.jpg" alt="">
      </div>
      <div class="infoPerfil conteudo">
        <p class="nome">Renato</p>
        <p class="email">renato.silva@gmail.com</p>
      </div>
      <div class="maisInfo conteudo">
        <i class="fa-solid fa-angle-right"></i>
      </div>
    </div>
  </div>
  <!-- FIM DO MENU LATERAL -->
  <div id="main">
    <div class="conteudoDashboard">
      <div class="div_titulo_mercado">
        <h1> Carrefour 12312</h1>
      </div>
      <div class="div_escolhermes">
        <div class="logo">
          <h1>In<span>Flow</span></h1>
        </div>
        <div class="select">
          <label for="mes">Escolha o mês:</label>
          <br>
          <select id="mes">
            <option value="janeiro">Janeiro</option>
            <option value="fevereiro">Fevereiro</option>
            <option value="marco">Março</option>
            <option value="abril">Abril</option>
            <option value="maio">Maio</option>
            <option value="junho">Junho</option>
            <option value="julho">Julho</option>
            <option value="agosto">Agosto</option>
            <option value="setembro">Setembro</option>
            <option value="outubro">Outubro</option>
            <option value="novembro">Novembro</option>
            <option value="dezembro">Dezembro</option>
          </select>
          <label for="ano">Escolha o ano:</label>
          <br>
          <select id="ano">
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
          </select>

          <button id="btn"> Buscar</button>
        </div>
          <button id="btn"> Buscar</button>
        </div>

      </div>
      <div id="div_mes_escolhido"> </div>
      <div class="elementosKPI">
        <div class="kpi k1">
          <p class="titulo">Ativações totais</p>
          <div class="dados">
            <p>40000</p>
      </div>
      <div id="div_mes_escolhido"> </div>
      <div class="elementosKPI">
        <div class="kpi k1">
          <p class="titulo">Ativações totais</p>
          <div class="dados">
            <p>40000</p>

            <p>10% Maior que o mes passado</p>
          </div>
        </div>
        <div class="kpi k2">
          <p class="titulo">Corredor com maior fluxo</p>
          <div class="dados">
            <p>6</p>
            <p>Com picos a sexta no periodo da tarde</p>
          </div>
        </div>
        <div class="kpi k3">
          <p class="titulo"> Dia com maior fluxo</p>
          <div class="dados">
            <p>10</p>
            <p>10% Maior que o mes passado</p>
          </div>
        </div>
        <div class="kpi k2">
          <p class="titulo">Corredor com maior fluxo</p>
          <div class="dados">
            <p>6</p>
            <p>Com picos a sexta no periodo da tarde</p>
          </div>
        </div>
        <div class="kpi k3">
          <p class="titulo"> Dia com maior fluxo</p>
          <div class="dados">
            <p>10</p>

          </div>
        </div>
        <div class="kpi k4">
          <p class="titulo">Corredor com queda de fluxo</p>
          <div class="dados">
            <p>Corredor 4</p>
          </div>
        </div>
        <div class="kpi k4">
          <p class="titulo">Corredor com queda de fluxo</p>
          <div class="dados">
            <p>Corredor 4</p>

          </div>
        </div>
      </div>
      <!-- <div class="calendar">
          </div>
        </div>
      </div>
      <!-- <div class="calendar">
          <div class="header">
            <button id="prev">&#9664;</button>
            <h2 id="monthYear"></h2>
            <button id="next">&#9654;</button>
          </div>
          <div class="weekdays">
            <div>Sun</div>
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
          </div>
          <div class="days" id="calendarDays"></div>
          <div class="selection-info">
            <p>Selected: <span id="selectionDisplay">None</span></p>
          </div>
        </div> -->

      <div class="conteudoGrafico">
      <div class="conteudoGrafico">


        <div class="grafico ">
          <canvas id="graficoPizza"></canvas>
        </div>
        <div class="grafico ">
          <canvas id="grafico2"></canvas>
        </div>
      </div>
      <div class="corredores">
        <div onclick="obterDados(1)" class="corredor">
          <h3>Corredor 1</h3>
          <p>Movimentação: 10</p>
        </div>
        <div onclick="obterDados(2)" class="corredor">
          <h3>Corredor 2</h3>
          <p>Movimentação: 10</p>
        </div>
        <div onclick="obterDados(3)" class="corredor">
          <h3>Corredor 3</h3>
          <p>Movimentação: 10</p>
        </div>
        <div onclick="obterDados(4)" class="corredor">
          <h3>Corredor 4</h3>
          <p>Movimentação: 10</p>
        </div>
        <div onclick="obterDados(5)" class="corredor">
          <h3>Corredor 5</h3>
          <p>Movimentação: 10</p>
        </div>
        <div onclick="obterDados(6)" class="corredor">
          <h3>Corredor 6</h3>
          <p>Movimentação: 10</p>
        </div>
      </div>
      <div id="container-corredor" class="container-corredor">
        <select id="ano_g3">
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
        </select>
        <div class="conteudoGrafico1" id="conteudoGrafico" style="display: none;">
          <!-- <div class="grafico"> -->
          <div class="elementosKPI">
            <div class="kpi k1">
              <p class="titulo">Melhor periodo para promoções</p>
              <div class="dados">
                <p>Manhã</p>
              </div>
            </div>
            <div class="kpi k2">
              <p class="titulo">Melhor dia do mês</p>
              <div class="dados">
                <p>21</p>
              </div>
            </div>
          </div>

          <canvas id="grafico3" height="100"></canvas>
          <!-- </div> -->
        </div>
      </div>


      <div class="heatmaparea">
        <h1>Mapa de calor</h1>
        <p>Acompanhe em tempo real a movimentação</p>
        <div class="heatmap">
          <div id="heatmapContainer"></div>
        </div>
      </div>
      <div class="heatmaparea">
        <h1>Mapa de calor</h1>
        <p>Acompanhe em tempo real a movimentação</p>
        <div class="heatmap">
          <div id="heatmapContainer"></div>
        </div>
      </div>

    </div>
  </div>
</div>
</div>
</div>
</div>
    </div>
  </div>
</div>
</div>
</div>
</div>
</body>
<div id="btnSupermercado" class="btns-dash">
</div>
<div id="graficos" class="graficos">
</div>


</html>
<script>
  let idSupermercadoAtual = 0

  window.onload = exibirSupermercadosDoUsuario();
  function exibirSupermercadosDoUsuario() {
    var supermercados = JSON.parse(sessionStorage.SUPERMERCADO);
    supermercados.forEach(item => {
      document.getElementById("btnSupermercado").innerHTML += `
    var supermercados = JSON.parse(sessionStorage.SUPERMERCADO);
    supermercados.forEach(item => {
      document.getElementById("btnSupermercado").innerHTML += `
            <button class="btn-chart" onclick="exibirSupermercado(${item.id})" id="btnSupermercado${item.id}">${item.nome}</button>
            `

      document.getElementById("graficos").innerHTML += `
      document.getElementById("graficos").innerHTML += `
                <div id="grafico${item.id}" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloSupermercado${item.id}">${item.nome}</span>
                    </h3>
                    <div class="graph">
                        <canvas id="myChartCanvas${item.id}"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura${item.id}" style="color: white"></p>
                    </div>
                </div>
            `

      obterDadosGrafico(item.id)
    });

    if (supermercados.length > 0) {
      exibirSupermercado(supermercados[0].id)
    }
  }
    if (supermercados.length > 0) {
      exibirSupermercado(supermercados[0].id)
    }
  }

  function alterarTitulo(idSupermercado) {
    var tituloSupermercado = document.getElementById(`tituloSupermercado${idSupermercado}`)
    var descricao = JSON.parse(sessionStorage.SUPERMERCADO).find(item => item.id == idSupermercado).descricao;
    tituloSupermercado.innerHTML = "Últimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>" + descricao + "</span>"
  }
  function alterarTitulo(idSupermercado) {
    var tituloSupermercado = document.getElementById(`tituloSupermercado${idSupermercado}`)
    var descricao = JSON.parse(sessionStorage.SUPERMERCADO).find(item => item.id == idSupermercado).descricao;
    tituloSupermercado.innerHTML = "Últimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>" + descricao + "</span>"
  }

  function exibirSupermercado(idSupermercado) {
    idSupermercadoAtual = idSupermercado
    let todosOsGraficos = JSON.parse(sessionStorage.SUPERMERCADO);

    for (i = 0; i < todosOsGraficos.length; i++) {
      // exibindo - ou não - o gráfico
      if (todosOsGraficos[i].id != idSupermercado) {
        let elementoAtual = document.getElementById(`grafico${todosOsGraficos[i].id}`)
        if (elementoAtual.classList.contains("display-block")) {
          elementoAtual.classList.remove("display-block")
        }
        elementoAtual.classList.add("display-none")

        // alterando estilo do botão
        let btnAtual = document.getElementById(`btnSupermercado${todosOsGraficos[i].id}`)
        if (btnAtual.classList.contains("btn-pink")) {
          btnAtual.classList.remove("btn-pink")
        }
        btnAtual.classList.add("btn-white")
      }
    }
        // alterando estilo do botão
        let btnAtual = document.getElementById(`btnSupermercado${todosOsGraficos[i].id}`)
        if (btnAtual.classList.contains("btn-pink")) {
          btnAtual.classList.remove("btn-pink")
        }
        btnAtual.classList.add("btn-white")
      }
    }

    // exibindo - ou não - o gráfico
    let graficoExibir = document.getElementById(`grafico${idSupermercado}`)
    graficoExibir.classList.remove("display-none")
    graficoExibir.classList.add("display-block")

    // alterando estilo do botão
    let btnExibir = document.getElementById(`btnSupermercado${idSupermercado}`)
    btnExibir.classList.remove("btn-white")
    btnExibir.classList.add("btn-pink")
  }
    // alterando estilo do botão
    let btnExibir = document.getElementById(`btnSupermercado${idSupermercado}`)
    btnExibir.classList.remove("btn-white")
    btnExibir.classList.add("btn-pink")
  }


  function obterDadosGrafico(idSupermercado) {
  function obterDadosGrafico(idSupermercado) {

    alterarTitulo(idSupermercado)
    alterarTitulo(idSupermercado)


    fetch(`/medidas/fluxo/${idSupermercado}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();
    fetch(`/medidas/fluxo/${idSupermercado}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta, idSupermercado);
          plotarGrafico(resposta, idSupermercado);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*

  function plotarGrafico(resposta, idSupermercado) {
  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*

  function plotarGrafico(resposta, idSupermercado) {
    console.log('Iniciando plotagem do gráfico de barras...');

    // Labels dinâmicas - nomes dos corredores
    let labels = [];

    // Dados do fluxo de pessoas por corredor
    let dadosFluxo = [];

    // Preenchendo os dados a partir da resposta
    for (let i = 0; i < resposta.length; i++) {
      let registro = resposta[i];
      labels.push(`Corredor ${registro.corredor}`);
      dadosFluxo.push(registro.fluxoPessoas);
      let registro = resposta[i];
      labels.push(`Corredor ${registro.corredor}`);
      dadosFluxo.push(registro.fluxoPessoas);
    }

    // Estrutura de dados para o gráfico
    const dados = {
      labels: labels,
      datasets: [{
        label: 'Fluxo de Pessoas',
        data: dadosFluxo,
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    };

    // Configuração do gráfico de barras
    const config = {
      type: 'bar',
      data: dados,
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Quantidade de Pessoas'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Corredores'
            }
          }
        },
        plugins: {
          legend: {
            display: true
          },
          title: {
            display: true,
            text: 'Fluxo de Pessoas por Corredor'
          }
        }
      }
      type: 'bar',
      data: dados,
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Quantidade de Pessoas'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Corredores'
            }
          }
        },
        plugins: {
          legend: {
            display: true
          },
          title: {
            display: true,
            text: 'Fluxo de Pessoas por Corredor'
          }
        }
      }
    };

    // Renderizando o gráfico na tela
    const myChart = new Chart(
      document.getElementById(`myChartCanvas${idSupermercado}`),
      config
      document.getElementById(`myChartCanvas${idSupermercado}`),
      config
    );
  }
  }




  const ctx = document.getElementById('graficoPizza').getContext('2d');
  const graficoPizza = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Manhã', 'Tarde', 'Noite'],
      datasets: [{
        label: 'Movimentação por período',
        data: [35, 40, 25], // porcentagens ou valores absolutos
        backgroundColor: ['#0f766e', '#14b8a6', '#5eead4'],
        borderColor: '#fff',
        borderWidth: 1
      }]
    },
    options: {
      plugins: {
        title: {
          display: true,
          text: 'Distribuição de Movimento por Período do Dia',
          font: {
            size: 18
          }
        },
        legend: {
          position: 'bottom'
        }
      }
    }
  });



  const heatmapInstance = h337.create({
    container: document.getElementById('heatmapContainer'),
    radius: 70,
  });

  const data = {
    max: 100,
    data: [
      { x: 500, y: 100, value: 100 },
      { x: 400, y: 300, value: 60 },
      { x: 100, y: 400, value: 90 },
      { x: 200, y: 200, value: 40 },
      { x: 100, y: 100, value: 70 },
      { x: 250, y: 450, value: 80 },
      { x: 500, y: 400, value: 95 },
      { x: 50, y: 300, value: 40 },
    ]
  };

  heatmapInstance.setData(data);


  const ctx2 = document.getElementById('grafico2');
  const grafico2 = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: ['Corredor 1', 'Corredor 2', 'Corredor 3', 'Corredor 4', 'Corredor 5', 'Corredor 6', 'Corredor 7', 'Corredor 8', 'Corredor 9', 'Corredor 10'],
      datasets: [{
        label: 'Pessoas', //<- legenda da tabela
        data: [10, 22, 43, 32, 11, 54, 43, 21, 55, 53], //<- muda o valor dos dados no grafico para adicionar mais valores é necessario adicionar mais corredores acima
        borderWidth: 1,
        borderColor: '#115e59',
        backgroundColor: '#115e59'
      }]
    },
    options: {
      tension: 0.5,
      scales: {
        y: {
          beginAtZero: true
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'Movimentação por corredor',
          font: {
            size: 24
          },
          color: '#333' // (opcional) cor do título
        }
      }
    }
  })
  const ctx3 = document.getElementById('grafico3').getContext('2d');
  const grafico3 = new Chart(ctx3, {
    type: 'bar',
    data: {
      labels: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
      datasets: [{
        label: 'Pessoas',
        data: data,
        borderWidth: 1,
        borderColor: '#115e59',
        backgroundColor: '#115e59'
      }]
    },
    options: {
      tension: 0.5,
      scales: {
        y: {
          beginAtZero: true
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'Movimentação por mês',
          font: {
            size: 24
          },
          color: '#333'
        }
      }
    }
  });

  function exibirCorredores() {
    JSON.parse(sessionStorage.CORREDORES).forEach(item => {
      document.getElementById("corredores").innerHTML += `
    JSON.parse(sessionStorage.CORREDORES).forEach(item => {
      document.getElementById("corredores").innerHTML += `
                    <div class="corredor">
            
                            <h1>${item.id}</h1>
                            <p>AREA:${item.nome}</p>

                      
                    </div>
                    `
    });
  }

  function obterDados(idCorredor) {

    var ano = ano_g3.value

    fetch(`/dashboard/dadosCorredor/${idSupermercadoAtual}/${idCorredor}/${ano}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();
        });
        console.log(idSupermercadoAtual, idCorredor, ano)
          const grafico = document.getElementById('conteudoGrafico')
          grafico.style.display = 'block'
          grafico3.data.datasets[0].data = resposta
          grafico3.update()

      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }


</script>